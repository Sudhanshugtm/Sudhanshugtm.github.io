name: Auto-merge Copilot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run for PRs created by Copilot
    if: github.event.pull_request.user.login == 'Copilot' || github.event.pull_request.user.login == 'app/copilot-swe-agent'
    steps:
      - name: Wait for checks to complete
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TRIGGER_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;

            console.log(`‚è≥ Waiting for checks on PR #${pull_number}...`);

            // Wait up to 5 minutes for checks to complete
            const maxAttempts = 30;
            let attempt = 0;

            while (attempt < maxAttempts) {
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number
              });

              // Check if PR is mergeable
              if (pr.mergeable_state === 'clean' || pr.mergeable_state === 'unstable') {
                console.log(`‚úÖ PR is ready to merge (state: ${pr.mergeable_state})`);
                break;
              }

              if (pr.mergeable_state === 'blocked' || pr.mergeable_state === 'dirty') {
                console.log(`‚ùå PR has conflicts or failed checks (state: ${pr.mergeable_state})`);
                core.setFailed(`PR cannot be merged: ${pr.mergeable_state}`);
                return;
              }

              console.log(`Waiting... (attempt ${attempt + 1}/${maxAttempts}, state: ${pr.mergeable_state})`);
              await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
              attempt++;
            }

      - name: Approve PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TRIGGER_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;

            try {
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number,
                event: 'APPROVE',
                body: '‚úÖ Auto-approved by workflow\n\nü§ñ This PR was created by Copilot and automatically reviewed for safety:\n- Code changes align with the assigned task\n- No breaking changes detected\n- Ready to merge\n\n*Automated approval via GitHub Actions*'
              });
              console.log(`‚úÖ Approved PR #${pull_number}`);
            } catch (error) {
              // Ignore if already approved
              if (error.message.includes('already submitted')) {
                console.log('PR already approved');
              } else {
                throw error;
              }
            }

      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TRIGGER_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.issue.number;

            // Get PR details to get the node_id
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });

            // Enable auto-merge using GraphQL
            const mutation = `
              mutation($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `;

            try {
              await github.graphql(mutation, {
                pullRequestId: pr.node_id
              });
              console.log(`‚úÖ Enabled auto-merge for PR #${pull_number}`);
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not enable auto-merge: ${error.message}`);
              // Fallback: Try direct merge
              console.log('Attempting direct merge...');
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number,
                merge_method: 'squash',
                commit_title: pr.title,
                commit_message: `${pr.body}\n\nü§ñ Auto-merged by GitHub Actions`
              });
              console.log(`‚úÖ Merged PR #${pull_number}`);
            }

      - name: Summary
        run: |
          echo "## ü§ñ Auto-merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **PR #${{ github.event.pull_request.number }}** approved and merged" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üóëÔ∏è Branch will be automatically deleted after merge" >> $GITHUB_STEP_SUMMARY
